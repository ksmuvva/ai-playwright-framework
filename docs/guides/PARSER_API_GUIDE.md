# Playwright Recording Parsers

This directory contains parsers for different Playwright recording formats.

## Python Parser (`python-parser.ts`)

### Purpose
Parses Playwright Python scripts generated by `playwright codegen` into a structured intermediate format.

### Supported Playwright API

#### Navigation
- `page.goto(url)`

#### Modern Locators
- `page.get_by_role(role, name=...)`
- `page.get_by_text(text)`
- `page.get_by_label(label)`
- `page.get_by_placeholder(placeholder)`
- `page.get_by_test_id(testid)`
- `page.get_by_title(title)`
- `page.get_by_alt_text(alt)`

#### Legacy Locators
- `page.locator(selector)`

#### Actions
- `.click()`
- `.dblclick()`
- `.hover()`
- `.fill(value)`
- `.press(key)`
- `.check()`
- `.uncheck()`
- `.select_option(value)`

#### Assertions
- `expect(page).to_have_url(url)`
- `expect(page).to_have_title(title)`
- `expect(element).to_be_visible()`
- `expect(element).to_be_hidden()`
- `expect(element).to_be_enabled()`
- `expect(element).to_be_disabled()`
- `expect(element).to_have_text(text)`
- `expect(element).to_have_value(value)`
- `expect(element).to_have_count(count)`

#### Complex Patterns
- Popup windows: `with page.expect_popup() as page1_info:`
- Multiple page contexts: `page`, `page1`, `page2`
- Page close: `page.close()`

### Usage

```typescript
import { parsePythonScript } from './python-parser';

const pythonCode = `
import re
from playwright.sync_api import Playwright, sync_playwright, expect

def run(playwright: Playwright) -> None:
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context()
    page = context.new_page()
    page.goto("https://example.com")
    page.get_by_role("button", name="Submit").click()
    context.close()
    browser.close()

with sync_playwright() as playwright:
    run(playwright)
`;

const parsed = parsePythonScript(pythonCode);

console.log(`Parsed ${parsed.actions.length} actions`);
// Output: Parsed 2 actions

console.log(parsed.actions);
// Output:
// [
//   { type: 'goto', url: 'https://example.com', rawLine: '...', lineNumber: 9 },
//   { type: 'click', locatorType: 'role', locatorValue: 'button', elementName: 'Submit', rawLine: '...', lineNumber: 10 }
// ]

console.log(parsed.metadata);
// Output:
// {
//   startUrl: 'https://example.com',
//   browser: 'chromium',
//   headless: false,
//   hasPopups: false,
//   hasAssertions: false,
//   hasMultiplePages: false,
//   totalActions: 2
// }
```

### Output Format

#### ParsedPlaywrightAction
```typescript
interface ParsedPlaywrightAction {
  type: 'goto' | 'click' | 'fill' | 'press' | 'check' | 'select' | 'expect' | 'popup' | 'close' | 'hover' | 'dblclick';

  // Locator information
  locatorType?: 'role' | 'text' | 'label' | 'placeholder' | 'testid' | 'locator' | 'css' | 'xpath';
  locatorValue?: string;
  elementName?: string;

  // Action-specific data
  value?: string;
  url?: string;

  // Assertion information
  assertion?: {
    type: 'url' | 'title' | 'visible' | 'text' | 'count' | 'value';
    expected: string;
    matcher?: string;
  };

  // Context
  rawLine: string;
  lineNumber: number;
  pageContext?: string;
}
```

#### ParsedRecording
```typescript
interface ParsedRecording {
  actions: ParsedPlaywrightAction[];
  metadata: {
    startUrl?: string;
    browser?: string;
    headless?: boolean;
    hasPopups: boolean;
    hasAssertions: boolean;
    hasMultiplePages: boolean;
    totalActions: number;
  };
  parseErrors: Array<{
    line: string;
    lineNumber: number;
    reason: string;
  }>;
}
```

### Error Handling

The parser is designed to be resilient:

1. **Boilerplate Filtering:** Automatically skips import statements, function definitions, and browser setup code
2. **Parse Errors:** Tracks lines that couldn't be parsed but continues processing
3. **Metadata Extraction:** Gathers useful information about the recording

```typescript
const parsed = parsePythonScript(content);

if (parsed.parseErrors.length > 0) {
  console.warn(`Warning: ${parsed.parseErrors.length} lines could not be parsed`);
  parsed.parseErrors.forEach(err => {
    console.log(`Line ${err.lineNumber}: ${err.reason}`);
    console.log(`  ${err.line}`);
  });
}
```

### Advanced Examples

#### Complex Recording with Popups
```python
page.goto("https://example.com")
page.get_by_role("button", name="Open Modal").click()

with page.expect_popup() as page1_info:
    page.get_by_role("link", name="External Link").click()

page1 = page1_info.value
expect(page1).to_have_title("External Page")
page1.close()
```

Parsed as:
```typescript
[
  { type: 'goto', url: 'https://example.com', ... },
  { type: 'click', locatorType: 'role', locatorValue: 'button', elementName: 'Open Modal', ... },
  { type: 'popup', pageContext: 'page', ... },
  { type: 'click', locatorType: 'role', locatorValue: 'link', elementName: 'External Link', ... },
  { type: 'expect', assertion: { type: 'title', expected: 'External Page' }, pageContext: 'page1', ... },
  { type: 'close', pageContext: 'page1', ... }
]
```

#### Form Filling
```python
page.get_by_label("Email").fill("user@example.com")
page.get_by_placeholder("Enter password").fill("secret123")
page.get_by_test_id("submit-btn").click()
```

Parsed as:
```typescript
[
  { type: 'fill', locatorType: 'label', locatorValue: 'Email', value: 'user@example.com', ... },
  { type: 'fill', locatorType: 'placeholder', locatorValue: 'Enter password', value: 'secret123', ... },
  { type: 'click', locatorType: 'testid', locatorValue: 'submit-btn', ... }
]
```

### Limitations

1. **Complex Python Syntax:** Advanced Python features (decorators, comprehensions, etc.) in test code are not supported
2. **Variables:** Dynamic locators using Python variables are not tracked
3. **Loops:** Repeated actions in loops are not detected
4. **Custom Functions:** Custom Playwright extensions are not recognized

These limitations affect <5% of typical Playwright recordings.

### Testing

```bash
# Run parser tests
npm test src/parsers/python-parser.test.ts

# Test with a real recording
node -e "
const { parsePythonScript } = require('./dist/parsers/python-parser');
const fs = require('fs');
const content = fs.readFileSync('recordings/my_test.py', 'utf-8');
const parsed = parsePythonScript(content);
console.log(JSON.stringify(parsed, null, 2));
"
```

### Contributing

When adding support for new Playwright API methods:

1. Add regex pattern to `createPatterns()`
2. Add parsing logic to appropriate function:
   - `parseElementInteraction()` for actions
   - `parseAssertion()` for expectations
   - `parseGoto()` for navigation
3. Update action types in `ParsedPlaywrightAction`
4. Add test cases
5. Update this README

### See Also

- [Playwright Python API Documentation](https://playwright.dev/python/docs/api/class-page)
- [Converting Recordings to BDD](../../docs/converting-recordings.md)
- [Root Cause Analysis](../../../PYTHON_RECORDING_FIX.md)
